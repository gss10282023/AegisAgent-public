services:
  green:
    image: mas-green:phase1
    build:
      context: ../../..
      dockerfile: agentbeats/green/Dockerfile
    environment:
      PYTHONUNBUFFERED: "1"
      # When the MAS harness runs inside this container (Step 9), its case-site HTTP server must be
      # reachable from the host-run Android device. Bind to 0.0.0.0 and publish a fixed port.
      MAS_CASE_SITE_BIND_HOST: ${MAS_CASE_SITE_BIND_HOST:-0.0.0.0}
      MAS_CASE_SITE_SERVER_PORT: ${MAS_CASE_SITE_SERVER_PORT:-18080}
    ports:
      - "${MAS_CASE_SITE_SERVER_PORT:-18080}:${MAS_CASE_SITE_SERVER_PORT:-18080}"
    command: ["--host", "0.0.0.0", "--port", "9009", "--card-url", "http://green:9009/"]
    volumes:
      - ../../../runs:/home/agentbeats/mas/runs
      - ./scenario.toml:/home/agentbeats/mas/agentbeats/scenarios/phase1_smoke/scenario.toml:ro

  purple:
    image: mas-purple-droidrun:phase1
    build:
      context: ../../..
      dockerfile: agentbeats/purple/droidrun_baseline/Dockerfile
    environment:
      PYTHONUNBUFFERED: "1"
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-}
      DROIDRUN_MANAGER_MODEL: ${DROIDRUN_MANAGER_MODEL:-}
      DROIDRUN_EXECUTOR_MODEL: ${DROIDRUN_EXECUTOR_MODEL:-}
      DROIDRUN_CODEACT_MODEL: ${DROIDRUN_CODEACT_MODEL:-}
      # DroidRun Portal auto-setup (optional overrides)
      DROIDRUN_PORTAL_APK_URL: ${DROIDRUN_PORTAL_APK_URL:-}
      DROIDRUN_PORTAL_VERSION: ${DROIDRUN_PORTAL_VERSION:-}
      DROIDRUN_PORTAL_DOWNLOAD_BASE: ${DROIDRUN_PORTAL_DOWNLOAD_BASE:-}
      DROIDRUN_PORTAL_LATEST: ${DROIDRUN_PORTAL_LATEST:-}
      DROIDRUN_PORTAL_DOWNLOAD_TIMEOUT_S: ${DROIDRUN_PORTAL_DOWNLOAD_TIMEOUT_S:-}
      AGENTBEATS_PURPLE_TRACE_DIR: ${AGENTBEATS_PURPLE_TRACE_DIR:-/tmp/agentbeats_purple_droidrun}
    command: ["--host", "0.0.0.0", "--port", "9010", "--card-url", "http://purple:9010/"]

  phase1_smoke:
    image: mas-green:phase1
    build:
      context: ../../..
      dockerfile: agentbeats/green/Dockerfile
    depends_on:
      - green
      - purple
    entrypoint: ["python", "agentbeats/scenarios/phase1_smoke/run_smoke.py"]
    environment:
      GREEN_URL: http://green:9009
      PURPLE_URL: http://purple:9010
      AGENT_CARD_TIMEOUT_S: ${AGENT_CARD_TIMEOUT_S:-60}
      ASSESSMENT_TIMEOUT_S: ${ASSESSMENT_TIMEOUT_S:-900}
    volumes:
      - ../../../runs:/home/agentbeats/mas/runs
      - ./scenario.toml:/home/agentbeats/mas/agentbeats/scenarios/phase1_smoke/scenario.toml:ro
