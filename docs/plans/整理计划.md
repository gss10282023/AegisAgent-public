```markdown
# mas-harness 整理计划（目录/职责/迁移步骤）

> 目标：把 `mas-harness/` 从“代码 + 阶段性产物混在一起”整理成 **职责清晰、按功能归类、可渐进迁移** 的结构；同时保持 Phase 3 文档里约定的关键入口（`run_agent / agentctl / conformance / ingestion / evidence pack`）不变或提供兼容层。

---

## 1. 先把 mas-harness 的“作用”说清楚

结合：
- **《方案.md》** 对 Harness/TCB 的定义（Harness 负责策略执行、证据采集、可审计确认 UI 等），
- **《Agent vs Agent 实现方案.md》** 与 **《Phase3 详细方案.md》** 对 Phase0–3 的工程交付物定义（Runner/EnvAdapter/Executor、Evidence Pack、Oracle Zoo、action trace 分级 L0–L2、三态口径、conformance、agentctl 等），

可以把 `mas-harness/` 的定位固定为：

**mas-harness = 评测执行与审计的可信计算基（TCB + Runner）**

它应该只负责：

1) **跑（Runner）**：把一个 case（task/policy/eval）在某个环境画像（env_profile）里执行成 episode。  
2) **采（Evidence）**：对 episode 产生可复现、可审计的 evidence bundle（obs/action/oracle/device probes）。  
3) **判（Checkers/Oracles）**：用 deterministic/hard-oracle 为主的方式做 success 判定与（后续）安全违规判定。  
4) **接（Adapters/Ingestion）**：
   - runnable：通过 adapter 让各种 mobile agent “可跑、可采证据”。
   - audit_only：通过 ingestion 把第三方 trajectory 映射到你的 evidence 合同。
5) **验（Conformance + AgentCTL）**：
   - conformance suite：验证“能跑 + 产证据 + 语义字段正确”
   - agentctl：开发者在 terminal 快速切换 agent、跑固定 smoke 或 NL smoke。

> **不应该放进 mas-harness 的东西**：
> - benchmark case 数据（应在 `mas-public/`、`mas-hidden/`、`mas-conformance/`）
> - agent 列表/快照/适配器工件（应在 `mas-agents/`）
> - 规范与 schema（应在 `mas-spec/`）
> - 长期保留的“阶段性设计文档”（建议统一到 `docs/`，而不是散在 repo 根目录）

---

## 2. 当前结构的“乱”主要来自哪里（客观盘点）

你现在的 `mas-harness/src/mas_harness/` 已经有一些按功能的子包：

- `action_evidence/`（L1/L2 的动作证据链）
- `agents/`（adapter manifest、loader、registry）
- `android/`（controller/env_adapter/executor）
- `cli/`（agentctl / run_agent / ingest / validate / snapshot…）
- `conformance/`（suite runner）
- `ingestion/`（trajectory ingestion registry/notes）
- `oracle_zoo/`（oracle 插件库）
- `tools/`（android_smoke / audit_bundle 等）

真正让人觉得“散/乱”的点主要是：

1) **大量“核心概念文件”还在包根目录平铺**（`evidence.py / action_normalizer.py / reporting.py / run_public.py / reset_grounding.py / validate_* / phase0_artifacts.py / phase3_smoke_cases.py / toy_*` 等）。  
2) **阶段性（phase）概念与长期稳定核心混在一起**：
   - `phase0_artifacts.py`、`phase3_smoke_cases.py` 是 phase 强相关；
   - `toy_env/toy_agent` 是 demo/CI smoke 强相关。  
3) **CLI 文件夹里既有“用户入口”也有“可复用业务逻辑”**，导致“看似 CLI，实际是核心流程实现”。  
4) **测试文件平铺**：pytest 能跑但阅读成本偏高（同一功能的测试散落在 `tests/` 根下）。  
5) **阶段性方案/计划文档散在 repo 根目录**，影响你希望的“阶段文件别放外面”。

---

## 3. 整理原则（不靠感觉，靠约束）

### 3.1 目录按“职责”分层，而不是按“文件类型”分层

建议用这条分层去决定文件属于哪里：

- **Core contracts（长期稳定）**：schema/动作类型/证据字段/manifest 字段/Oracle interface。
- **Runtime（执行链路）**：Runner、EnvAdapter、Executor、Reset、Comm proxy。
- **Integrations（接入）**：agent registry、adapter、ingestion、conformance。
- **Developer UX（开发者入口）**：CLI、tools。
- **Phase scaffolding（阶段性支架）**：smoke case 生成器、Phase0 固化产物生成器、阶段 README。
- **Examples（示例/玩具）**：toy env/agent（只服务 CI/smoke，不污染核心概念区）。

### 3.2 “入口薄、逻辑厚”的放置规则

- `mas_harness/cli/*`：只做 **参数解析 + 调用核心函数**；核心逻辑搬去对应功能包（runtime/integration/evidence）。
- 这样你之后想做 `console_scripts` 或者换成 `typer`，不会动核心逻辑。

### 3.3 迁移必须“可渐进”

任何移动都要满足：

- 旧 import path 先别断（保留薄 wrapper / re-export），
- 先迁核心逻辑，再迁 CLI，最后迁测试。

---

## 4. 推荐的目标结构（以“功能归类”为中心）

### 4.1 mas-harness 目录层级

建议把 `mas-harness/` 补齐成一个“有文档、有入口、有代码、有测试”的完整子项目：

```text
mas-harness/
  README.md                 # 解释：它是什么、它不是什么、最常用入口

  docs/
    INDEX.md                # 文档索引（设计/阶段/术语/FAQ）
    phases/
      phase0.md
      phase2.md
      phase3.md
    architecture/
      harness_tcb.md        # 从《方案.md》抽取“TCB/证据/确认 UI”核心定义
      evidence_contract.md  # evidence bundle 合同（字段/版本/兼容策略）
      action_trace.md       # L0/L1/L2 的语义
    operations/
      runbook_local.md      # 本地跑 conformance/agentctl 的说明

  src/
    mas_harness/
      __init__.py

      spec/                 # 只放“加载/校验 spec”的长期稳定逻辑
        spec_loader.py
        validate_case.py
        validate_specs.py

      evidence/             # evidence 的核心合同与工具
        __init__.py
        evidence.py
        evidence_pack.py
        ui_elements.py
        ref_applicability.py
        action_normalizer.py
        action_evidence/    # 你现有 action_evidence/ 整体搬进来（或保留原地也行）

      runtime/              # 跑起来的执行链路
        __init__.py
        run_public.py
        reset_grounding.py
        android/            # 你现有 android/ 整体搬进来（或保留原地也行）
        comm_proxy/         # 若后续扩展 L2 proxy，可独立出来

      oracles/              # Oracle 接口 + Oracle Zoo
        __init__.py
        factory.py          # 原 oracles.py：make_oracle
        zoo/                # 原 oracle_zoo/

      integration/          # “接入”相关（agent registry/adapter/conformance/ingestion）
        __init__.py
        agents/             # 原 agents/
        conformance/        # 原 conformance/
        ingestion/          # 原 ingestion/
        agentctl/           # 建议：把 agentctl 的核心逻辑放这里（CLI 只做 wrapper）

      reporting/            # 报告与统计口径（尤其 Phase3 口径）
        __init__.py
        aggregate.py        # 原 report.py
        phase3_bucketing.py # 原 reporting.py（更名，表达它不是通用 reporting）

      phases/               # 阶段性“支架代码”与固定产物生成器
        __init__.py
        phase0_artifacts.py
        phase3_smoke_cases.py

      examples/             # toy_env/toy_agent 不污染核心
        toy_env.py
        toy_agent.py

      cli/                  # 入口（薄）
        agentctl.py
        run_agent.py
        ingest_trajectory.py
        validate_registry.py
        snapshot_leaderboard.py
        report_regression_subset.py

      tools/                # 开发/运维工具（薄）
        audit_bundle.py
        android_smoke.py

  tests/
    unit/
      evidence/
      runtime/
      integration/
      oracles/
      reporting/
    fixtures/
```

> **说明**：
>
> * 这是“理想目标结构”。你不必一次做到位；下一节给出“最小改动、可渐进”的迁移步骤。
> * `action_evidence/`、`android/` 是否搬进 `evidence/` 与 `runtime/`，可以二选一：
>   * **搬进去**：目录更“按功能聚合”；
>   * **不搬**：改动更小，但 `mas_harness/` 根目录仍然有较多一级目录。

### 4.2 关于你提的两个点：CLI 与 conformance 放哪更好？

#### CLI（尤其 agentctl）

* **不建议把 `cli/` 整体放进 `agents/`**：
  * CLI 是“人用入口”，agents 是“接入层抽象”。
  * 把入口塞进接入层，会让 agents 模块边界变糊（以后会出现：为了一个命令引入一堆 argparse/IO）。
* **建议的折中**：
  * 保留 `mas_harness/cli/agentctl.py` 作为入口；
  * 把 agentctl 的“核心业务逻辑”移动到 `integration/agentctl/`（或 `integration/agents/agentctl.py`）；
  * CLI 只做：解析参数 → 调用 `integration.agentctl.run_*()`。

这样你既能满足“agent 接入相关逻辑聚在一起”，又不把 CLI 的外壳污染到 agents 核心。

#### conformance

* **conformance runner 代码**（发现/过滤/批量跑）属于 harness 的能力，应留在 `mas_harness`（建议归到 `integration/conformance/`）。
* **conformance cases 数据** 应该留在 `mas-conformance/cases/`：
  * 它是“用例数据”，不是“执行引擎”；
  * 也便于你对外声明：conformance 不进 benchmark，只做接入验证。

---

## 5. 阶段性文档不要散在根目录：建议统一到 docs/ 并做索引

你提到“不想把阶段性的文件放在外面”，建议把 repo 根目录的这类文档统一归档：

```text
docs/
  plans/
    方案.md
    Agent vs Agent实现方案.md
    Phase3详细方案.md
    更新计划.md
  oracles/
    oracle_catalog.md
    高价值 Oracle 扩展清单.md
  governance/
    agent_providers.md
    REPRODUCIBILITY.md
    ETHICS_AND_DUAL_USE.md
    SECURITY.md
```

然后：

* 根目录 `README.md` 只保留“项目介绍 + 快速入口”，并链接到 `docs/INDEX.md`。
* `mas-harness/docs/` 只放 harness 自己的“运行/开发文档”。

> 如果你更希望“所有阶段性内容都跟 harness 放一起”，也可以改成 `mas-harness/docs/plans/`，但从职责上讲更推荐放 repo 根 `docs/`（因为 Phase 文档是跨 `mas-spec/mas-public/mas-agents/mas-harness` 的）。

---

## 6. 可渐进迁移步骤（按风险从低到高）

下面每一步都是可独立提交的。

### Step 1：先补“索引/README”，让目录即文档

1. 新增 `mas-harness/README.md`：
   * 一句话定义 harness
   * 最常用命令（`run_public / run_agent / agentctl / conformance suite / audit_bundle`）
   * 指向 `mas-harness/docs/INDEX.md`
2. 新增 `mas-harness/docs/INDEX.md`：
   * 解释模块：evidence / runtime / integration / oracles / reporting
   * 标注“Phase0/2/3 的关键合同字段在哪里维护”

> 这一步不动任何 import，不影响 CI。

### Step 2：把“阶段支架/示例”从包根目录搬走（收益大、冲击小）

目标：减少 `mas_harness/` 根目录平铺文件。

建议移动：

* `phase0_artifacts.py` → `phases/phase0_artifacts.py`
* `phase3_smoke_cases.py` → `phases/phase3_smoke_cases.py`
* `toy_env.py`、`toy_agent.py` → `examples/`

兼容策略：

* 在原路径保留同名文件作为 **re-export wrapper**：
  例如原 `mas_harness/phase0_artifacts.py` 变成：`from .phases.phase0_artifacts import *`
* 这样外部 import（以及你现有 CLI/测试）不会断。

### Step 3：把“spec 校验相关”聚合到 `spec/`

移动：

* `spec_loader.py`、`validate_case.py`、`validate_specs.py` → `spec/`

兼容：同样保留原路径 wrapper。

额外收益：

* 你以后想把 spec 校验拆成独立包/独立 CI job，更容易。

### Step 4：把 evidence 相关聚合到 `evidence/`

移动：

* `evidence.py`、`evidence_pack.py`、`ui_elements.py`、`ref_applicability.py`、`action_normalizer.py`

（可选）把 `action_evidence/` 也搬到 `evidence/action_evidence/`。

兼容：保留 wrapper。

### Step 5：把 “Phase3 口径强相关”的 reporting 单独出来

* `report.py` 更像 CLI/工具：可放 `reporting/aggregate.py` 并由 `cli/report.py` 或 `python -m mas_harness.report` 入口调用。
* `reporting.py` 实际上是 **Phase3 bucketing 口径**：建议改名 `reporting/phase3_bucketing.py`。

### Step 6：让 CLI “薄化”

以 `agentctl` 为例：

现在 `cli/agentctl.py` 同时做：

* registry 读取
* case 生成
* phase0 artifacts
* 调 run\_agent

建议拆成：

* `integration/agentctl/core.py`：
  * `list_runnable_agents()`
  * `build_agentctl_case(mode, goal, …)`
  * `run_agentctl_case()`
* `cli/agentctl.py`：
  * argparse + 调用 core

同样模式适用于：

* `cli/run_agent.py`（核心跑链路可以下沉到 `runtime/runner.py`）
* `cli/validate_registry.py`（逻辑可放 `integration/agents/registry.py`）

### Step 7：整理 tests（只改目录，不改测试语义）

把 `mas-harness/tests/` 从平铺改为按功能目录：

* `tests/unit/evidence/`：obs digest、device\_input\_trace、action\_normalizer、action\_evidence
* `tests/unit/runtime/`：android executor/controller、reset\_grounding
* `tests/unit/integration/`：agent registry、agentctl、conformance、ingestion
* `tests/unit/oracles/`：oracle\_zoo（你已经有 `tests/oracle_zoo/`，可以整体搬进去）
* `tests/unit/reporting/`：bucketing/required sections

pytest 兼容：

* 你在 `pyproject.toml` 里指定了 `testpaths = ["mas-harness/tests"]`，不需要改；
* 只要新目录仍在 `mas-harness/tests` 下即可。

---

## 7. 搬迁后的“验收清单”（每一步都能自检）

每做完一个 step，至少跑：

* `make lint`
* `make test`
* `make smoke`

如果你做了 Android 相关重构：

* `make android_smoke`
* `make oracle_smoke`

以及：

* `python -m mas_harness.cli.agentctl list`（应能列 runnable agents）
* `python -m mas_harness.conformance.suite --list_cases mas-conformance/cases`（应能发现 conformance cases）

---

## 8. 最小化决策版本（如果你想“少改但马上变清晰”）

如果你现在只想做最少改动，但达到“更清晰”的效果，我建议按这个最小包：

1. 新增 `docs/INDEX.md`（repo 根）+ 把阶段性文档全部移动进去（根目录只留 README）。
2. `mas-harness/` 新增 README + docs/INDEX。
3. 只搬 3 类文件并保留 wrapper：
   * `phase0_artifacts.py / phase3_smoke_cases.py / toy_*`
   * `spec_loader.py / validate_*`
   * `reporting.py` 改名到 `reporting/phase3_bucketing.py`

做到这里，你打开 `mas_harness/` 的第一眼“平铺文件”会明显减少，同时不引入大范围 import 变更。

---

## 9. 附：从现状到目标结构的“文件归位表”（建议优先级）

> 下面是“应该挪”的建议，不要求一次做完。

* **优先级 A（最建议先挪）**
  * `phase0_artifacts.py` → `phases/`
  * `phase3_smoke_cases.py` → `phases/`
  * `toy_env.py / toy_agent.py` → `examples/`
  * `reporting.py` → `reporting/phase3_bucketing.py`
* **优先级 B（次优先）**
  * `spec_loader.py / validate_case.py / validate_specs.py` → `spec/`
  * `evidence.py / evidence_pack.py / ui_elements.py / ref_applicability.py / action_normalizer.py` → `evidence/`
* **优先级 C（最后做，属于“洁癖级重构”）**
  * CLI 全部“薄化”（把核心逻辑下沉到各自模块）
  * `action_evidence/` 与 `android/` 完整搬入 `evidence/` 与 `runtime/`

```

```

```
