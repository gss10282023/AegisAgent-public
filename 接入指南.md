## MAS Agent 接入指南（以 `ui-tars-7b` 为例）

目标：把外部/第三方 agent 以 **统一入口** 接入 `mas_harness`，并产出标准 evidence bundle（可审计、可复现）。

### 1) 在 registry 注册（`agent_registry.yaml`）

文件：`mas-agents/registry/agent_registry.yaml`

最小 runnable/core 推荐字段：

- `agent_id`: 唯一 id（建议与命令行一致）
- `availability: runnable`
- `tier: core`
- `execution_mode_supported: [planner_only]`（推荐）
- `action_trace_level: L0`（本系统执行器落盘 `device_input_trace.jsonl`）
- `adapter`: 指向 adapter 入口文件（例如 `mas-agents/adapters/ui-tars-7b/adapter.py`）
- `obs_modalities_required: [screenshot]`（UI‑TARS 7B 仅依赖截图；如你的 agent 需要控件树再加 `ui_elements`）

### 2) Adapter 工程结构（runnable）

目录：`mas-agents/adapters/<agent_id>/`

必需文件：

- `adapter.py`：导出 `create_adapter()`，并实现 `run_case(case_dir, evidence_dir, ctx) -> dict`
- `adapter_manifest.json`：至少包含：
  - `agent_id`
  - `default_coord_space`（UI-TARS 这类截图坐标建议 `screenshot_px`）

### 3) 运行闭环（建议写法）

Adapter 内部建议复用系统组件：

- `EvidenceWriter`：统一落盘到 runner 传入的 `evidence_dir`（不要自建目录）
- `AndroidEnvAdapter` + `AndroidExecutor`：统一 ADB 执行与 L0 证据落盘（`device_input_trace.jsonl`）
- 每一步至少写三条：
  - `writer.record_observation(step, obs)`
  - `writer.record_agent_call({...})`（外部模型调用摘要）
  - `writer.record_agent_action(step, raw_action_dict)`（raw + normalized）
  - 执行后再 `writer.record_action(step, normalized_action, result)`

### 4) Evidence bundle 落盘约定

`run_agent/agentctl` 会创建：

- `runs/.../run_manifest.json`
- `runs/.../env_capabilities.json`
- `runs/.../episode_XXXX/evidence/*`（标准 evidence pack）

其中 episode evidence 目录内包含（部分）：

- `screenshots/`、`ui_dump/`
- `obs_trace.jsonl`、`screen_trace.jsonl`、`device_trace.jsonl`
- `agent_call_trace.jsonl`、`agent_action_trace.jsonl`
- `action_trace.jsonl`、`device_input_trace.jsonl`（L0/L1/L2 时要求）
- `oracle_trace.jsonl`、`summary.json`

### 5) 外部模型调用（UI‑TARS / OpenRouter）

建议使用环境变量注入（禁止写入 repo）：

- `OPENROUTER_API_KEY`（或兼容 `OPEN_ROUTER_API_KEY`）
- `MAS_AGENT_PROVIDER=openrouter`
- `MAS_AGENT_MODEL_ID=bytedance/ui-tars-1.5-7b`（或你的 provider-facing slug）
- `MAS_AGENT_BASE_URL=https://openrouter.ai/api/v1`
- 推理参数：`MAS_AGENT_TEMPERATURE` / `MAS_AGENT_TOP_P` / `MAS_AGENT_MAX_TOKENS` / `MAS_AGENT_TIMEOUT_S`

调试输出（可选）：

- `MAS_UITARS_VERBOSE=1`：打印每步模型输出、解析结果、归一化动作与执行结果
- `MAS_UITARS_TRACE_COORDS=1`：额外打印坐标映射细节（normalizer 的 `[COORD] ...` trace）
- `MAS_UITARS_POST_ACTION_SLEEP_S=1.5`：每次执行完动作后额外 sleep（默认已是 1.5；设为 0 可关闭）

### 6) 本地运行示例

```bash
# 如果你的 key 在 .env（本项目不会自动加载），先导出到当前 shell：
set -a; source .env; set +a

# 固定 conformance 用例（验证闭环与证据）
python -m mas_harness.cli.agentctl fixed \
  --agent_id ui-tars-7b \
  --device_serial emulator-5554 \
  --output runs/agentctl/ui-tars-7b

# 跑一个公开 smoke case
python -m mas_harness.cli.run_agent \
  --agent_id ui-tars-7b \
  --case_dir mas-public/cases/smoke_001 \
  --android_serial emulator-5554 \
  --output runs/run_agent/ui-tars-7b
```
